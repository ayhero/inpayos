# 商户结算系统流程设计

## 1. 系统概述

商户结算系统负责处理商户交易的定期结算，包括手续费计算、资金清算和账户入账。系统按照商户配置的结算周期，自动处理交易结算并将资金入账到商户余额。

## 2. 核心流程

### 2.1 结算处理流程

```
交易完成 → 定时任务扫描 → 获取结算配置 → 匹配结算策略 → 计算手续费 → 生成结算记录 → 更新交易状态
```

**详细步骤**：

1. **交易扫描**：定时任务按交易类型（payin/payout）扫描最近几天内完成的交易
2. **配置获取**：根据商户ID从合同表获取结算配置（周期类型、结算策略等）
3. **策略匹配**：根据交易的包名、币种、国家等条件匹配对应的结算策略
4. **手续费计算**：按匹配的策略规则计算手续费（比例费率 + 固定费用）
5. **结算记录**：创建结算周期记录和交易结算记录
6. **状态更新**：更新原交易的结算状态

### 2.2 记账处理流程

```
扫描待记账结算 → 检查结算周期是否结束 → 调用账户服务 → 更新商户余额 → 标记记账完成
```

**详细步骤**：

1. **记录扫描**：每15分钟扫描状态为成功且结算结束时间已过的结算记录
2. **条件检查**：确认 `settle_end_at < 当前时间` 且 `completed_at` 为空
3. **余额更新**：调用账户服务的 `UpdateBalance` 方法，将结算金额入账
4. **完成标记**：更新结算记录的 `completed_at` 字段，标记记账完成

### 2.3 数据一致性修复流程

```
扫描结算交易记录 → 检查对应交易的settle_id → 并发修复缺失字段 → 更新交易状态
```

**详细步骤**：

1. **记录扫描**：每天扫描最近7天内有settle_log_id但对应交易settle_id为空的记录
2. **并发处理**：使用分页+批次+交易三级并发控制，最多5个批次，每批次10笔交易
3. **字段修复**：将交易记录的settle_id更新为对应的settle_log_id
4. **状态统计**：记录修复成功和失败的数量，确保数据一致性

## 3. 数据模型

### 3.1 核心表结构

**商户结算周期记录表** (`t_merchant_settle_log`)
- 按周期聚合的结算记录
- 包含交易统计、结算金额、手续费等信息
- 一个周期一条记录

**商户结算交易记录表** (`t_merchant_settle_transaction`)  
- 每笔交易的结算详情
- 关联到对应的结算周期记录
- 一笔交易一条记录

**商户合同配置表** (`t_merchant_contracts`)
- 存储商户的结算配置
- 包含结算周期类型、策略等信息

### 3.2 关系图

```
t_merchant_contracts (1) -----> (N) t_merchant_settle_log
                                         |
                                         v (1)
                                       (N) t_merchant_settle_transaction
```

## 4. 结算配置

### 4.1 结算周期类型

| 周期 | 说明 | 示例 |
|------|------|------|
| T+0 | 当日结算 | 交易当天结算 |
| T+1 | 次日结算 | 交易完成次日结算 |  
| T+2 | 两日后结算 | 交易完成后第2天结算 |
| T+3 | 三日后结算 | 交易完成后第3天结算 |
| W+1 | 下周结算 | 交易完成后下周结算 |
| M+1 | 下月结算 | 交易完成后下月结算 |

### 4.2 配置示例

```json
{
  "settle_config": {
    "type": "T+1",           // 默认T+1结算
    "ccy": "USD",            // 结算币种
    "strategies": ["default"],
    "payin": {               // 入金专用配置
      "type": "T+0",         // 入金当日结算  
      "strategies": ["payin_fast"]
    },
    "payout": {              // 出金专用配置
      "type": "T+1",         // 出金次日结算
      "strategies": ["payout_safe"]
    }
  }
}
```

## 5. 策略匹配

### 5.1 匹配规则

策略按以下条件进行匹配（优先级从高到低）：
1. 包名 (pkg)
2. 交易类型 (trx_type) 
3. 交易子类型 (trx_sub_type)
4. 交易方式 (trx_method)
5. 币种 (ccy)
6. 国家 (country)

### 5.2 费率计算

**费用 = 交易金额 × 比例费率 + 固定费用**

```go
fee := trxAmount.Mul(rate).Add(fixedFee)
settleAmount := trxAmount.Sub(fee)
```

## 6. 定时任务

### 6.1 任务配置

| 任务名称 | 执行频率 | 功能 |
|----------|----------|------|
| 入金结算处理 | 每天1点执行 | 处理payin类型交易结算 |
| 出金结算处理 | 每天2点执行 | 处理payout类型交易结算 |
| 结算记账处理 | 每15分钟 | 将到期结算记录入账到商户余额 |
| 交易settle_id修复 | 每天3点执行 | 修复交易记录中缺失的settle_id字段 |

### 6.2 任务参数

**结算处理任务**：
```json
{
  "trx_type": "payin",     // 交易类型
  "days": 3                // 处理最近3天的交易
}
```

**settle_id修复任务**：
```json
{
  "days": 7                // 处理最近7天的数据
}
```

## 7. 状态流转

### 7.1 交易结算状态

```
交易完成 → pending → processing → success → 记账完成
                               ↓            ↓
                            failed (重试)   数据修复
```

### 7.2 数据一致性检查

```
结算记录已创建 → 检查交易settle_id → 字段缺失 → 并发修复 → 数据一致
                                ↓
                            字段完整 → 跳过处理
```

### 7.2 关键时间节点

- **trx_start_at / trx_end_at**：交易时间范围
- **settle_start_at / settle_end_at**：结算时间范围  
- **completed_at**：记账完成时间（资金入账时间）

## 8. 核心代码结构

```
internal/
├── models/
│   ├── merchant.settle.go              # 结算周期记录模型
│   └── merchant.settle.transaction.go  # 结算交易记录模型（含限制字段查询）
├── services/  
│   ├── merchant.settle.go              # 结算业务逻辑（含并发优化）
│   └── merchant.settle.task.go         # 定时任务处理（4个核心任务）
└── protocol/
    └── settle.go                       # 结算相关协议定义（含修复结果统计）
```

### 8.1 并发优化设计

**三级并发控制**：
- **页级**：大数据量分页处理，避免内存溢出
- **批次级**：每页最多5个批次并发，控制数据库连接
- **交易级**：每批次最多10笔交易并发，平衡性能和资源

**性能优化措施**：
- 限制字段查询：只查询必要字段减少网络传输
- sync.WaitGroup：确保批次间顺序执行
- 信号量控制：防止协程过多导致资源耗尽
- 结果统计：实时监控处理进度和成功率

## 9. 数据一致性保障

### 9.1 settle_id修复机制

**问题背景**：在结算过程中，可能存在结算交易记录已创建但对应的原始交易记录的settle_id字段未正确更新的情况，导致数据不一致。

**解决方案**：通过定时任务自动检测和修复这类数据不一致问题。

**修复逻辑**：
1. 扫描有settle_log_id但对应交易settle_id为空的结算记录
2. 使用三级并发控制提高处理效率
3. 将交易记录的settle_id更新为对应的settle_log_id
4. 记录处理统计确保修复完整性

**并发处理架构**：
```
总数据量 → 分页处理(50条/页)
    ↓
每页数据 → 分批处理(最多5批次并发)  
    ↓
每批数据 → 分交易处理(最多10笔并发)
    ↓
批次完成 → 统计结果 → 下一批次
    ↓
页面完成 → 下一页面
```

**性能优化措施**：
- 限制字段查询：只查询settle_id, settle_log_id, trx_id, trx_type等必要字段
- 信号量控制：防止协程过多导致资源耗尽
- 分批统计：实时监控处理进度和成功率
- 错误隔离：单笔交易失败不影响其他交易处理

## 10. 业务场景示例

### 10.1 T+1结算示例

**场景**：商户配置T+1结算，用户在10月15日完成一笔100 USD的入金交易

1. **10月15日**：交易完成，状态为 completed
2. **10月16日凌晨**：结算任务运行，创建结算记录
   - 计算手续费：100 × 1% + 0.5 = 1.5 USD
   - 结算金额：100 - 1.5 = 98.5 USD
   - 结算周期：10月16日 00:00 - 23:59
3. **10月17日00:00后**：记账任务运行，98.5 USD入账到商户余额

### 9.2 数据记录

**结算周期记录**：
```json
{
  "settle_id": "SETTLE_20251016_M123456",
  "mid": 123456,
  "period_type": "T+1",
  "period": 20251016,
  "settle_start_at": 1729036800000,  // 2025-10-16 00:00:00
  "settle_end_at": 1729123199999,    // 2025-10-16 23:59:59
  "trx_total": 1,
  "settle_amount": "98.50"
}
```

**交易结算记录**：
```json
{
  "trx_id": "TRX_20251015_001",
  "settle_id": "SETTLE_TRX_20251015_001", 
  "settle_log_id": "SETTLE_20251016_M123456",
  "trx_amount": "100.00",
  "fee": "1.50",
  "settle_amount": "98.50",
  "status": "success"
}
```

### 10.2 数据修复示例

**场景**：系统检测到部分交易记录的settle_id字段缺失，需要进行数据修复

**修复前状态**：
```json
// 结算交易记录 - 正常
{
  "trx_id": "TRX_20251015_002",
  "settle_log_id": "SETTLE_20251016_M789012",
  "settle_amount": "195.75"
}

// 原始交易记录 - settle_id缺失
{
  "trx_id": "TRX_20251015_002",
  "amount": "200.00",
  "settle_id": "",           // 字段缺失
  "settle_status": "success"
}
```

**修复过程**：
1. **10月22日凌晨3点**：定时任务启动，扫描最近7天数据
2. **并发处理**：发现1000条需要修复的记录，分20页处理
3. **批次执行**：每页50条记录分5个批次，每批次10条并发处理
4. **字段更新**：将交易记录的settle_id更新为"SETTLE_20251016_M789012"
5. **结果统计**：成功修复998条，失败2条（交易记录不存在）

**修复后状态**：
```json
// 原始交易记录 - settle_id已修复
{
  "trx_id": "TRX_20251015_002",
  "amount": "200.00",
  "settle_id": "SETTLE_20251016_M789012",  // 已修复
  "settle_status": "success"
}
```

**处理日志**：
```
2025-10-22 03:00:01 [INFO] FixTransactionSettleID: found 1000 settle transactions to process
2025-10-22 03:00:01 [INFO] FixTransactionSettleID: processing page 1 with 50 transactions  
2025-10-22 03:00:02 [DEBUG] FixTransactionSettleID: completed batch 1 (success: 10, failed: 0)
...
2025-10-22 03:00:45 [INFO] FixTransactionSettleID: completed processing 1000 transactions (success: 998, failed: 2, duration: 44.2s)
```

---

*此文档描述了当前商户结算系统的核心设计和流程，重点关注业务逻辑、数据流转和数据一致性保障。*